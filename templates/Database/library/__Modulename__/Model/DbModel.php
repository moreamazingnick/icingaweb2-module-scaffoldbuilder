<?php

/* generated by icingaweb2-module-scaffoldbuilder | GPLv2+ */

namespace Icinga\Module\__Modulename__\Model;

use Icinga\Module\__Modulename__\Common\Database;
use ipl\Orm\Behaviors;
use ipl\Orm\Model;
use ipl\Sql\Connection;
use ipl\Stdlib\Filter;

abstract class DbModel extends Model
{

    public function beforeSave(Connection $db){
        $this->prepareForDatabase();
    }
    public function afterSave(Connection $db){
        $this->prepareForUsage();
    }

    public function getColumns(): array
    {
        return array_keys($this->getColumnDefinitions());
    }

    public function getValues()
    {
        $values=[];
        foreach ($this->getColumns() as $column) {
            if(isset($this->{$column})){
                $values[$column] = $this->{$column};
            }else{
                $values[$column] = null;
            }
        }
        return $values;
    }

    public function setValues($values)
    {
        foreach ($this->getColumns() as $column) {
            if (isset($values[$column])) {
                $this->{$column} = $values[$column];
            }else{
                $this->{$column} = null;
            }

        }
    }
    public function prepareForUsage()
    {
        $behavior = new Behaviors();
        $this->createBehaviors($behavior);
        $behavior->retrieve($this);
    }

    public function prepareForDatabase()
    {
        $behavior = new Behaviors();
        $this->createBehaviors($behavior);
        $behavior->persist($this);
    }
    public function save($asTransaction = true)
    {

        $db = Database::get();

        if($asTransaction){
            $db->beginTransaction();
        }

        $this->beforeSave($db);

        $values=$this->getValues();

        if (!isset ($this->id) || $this->id === null) {
            $db->insert($this->getTableName(), $values);
            $this->id = $db->lastInsertId();

        } else {
            $db->update($this->getTableName(), $values, [$this->getKeyName().' = ?' => $this->id]);
        }
        if($asTransaction){
            $db->commitTransaction();
        }
        $this->afterSave($db);
    }

    public function findbyPrimaryKey($id){
        $db = Database::get();
        return self::on($db)->filter(Filter::equal($this->getKeyName(), $id))->first();
    }
    public function delete()
    {
        $db = Database::get();
        $db->delete($this->getTableName(), [$this->getKeyName().' = ?' => $this->id]);
    }
}
